<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ‹±çŒª Â· æç®€è”æœºç‰ˆ</title>
  <style>
    :root { --primary: #3b82f6; --danger: #ef4444; --success: #10b981; --gray: #6b7280; --bg: #f8fafc; }
    * { margin:0; padding:0; box-sizing:border-box; font-family:"Segoe UI","PingFang SC","Microsoft YaHei",sans-serif; }
    body { background:var(--bg); color:#1e293b; padding:12px; max-width:1200px; margin:auto; line-height:1.5; }
    .header { text-align:center; margin:16px 0; padding:12px; border-radius:12px; background:white; box-shadow:0 2px 10px rgba(0,0,0,0.08); }
    .header h1 { font-size:1.8rem; margin:8px 0; color:var(--primary); display:flex; justify-content:center; gap:8px; }
    .room-bar { background:white; border-radius:12px; padding:14px; box-shadow:0 2px 8px rgba(0,0,0,0.1); display:flex; flex-wrap:wrap; gap:12px; align-items:center; justify-content:space-between; margin:16px 0; }
    .players-grid { display:grid; grid-template-columns:repeat(auto-fit, minmax(220px,1fr)); gap:16px; margin:16px 0; }
    .player-card { background:white; border-radius:12px; padding:16px; box-shadow:0 2px 6px rgba(0,0,0,0.08); text-align:center; transition:all 0.2s; min-height:90px; display:flex; flex-direction:column; align-items:center; justify-content:center; }
    .player-name { font-weight:600; margin:4px 0; font-size:1.1rem; }
    .player-score { font-size:1.4rem; font-weight:700; margin-top:4px; }
    .player-score.negative { color:var(--danger); }
    .player-score.positive { color:var(--success); }
    .current-turn { border:2px solid var(--primary); box-shadow:0 0 0 4px rgba(59,130,246,0.15); transform:scale(1.03); }
    .table-area { background:white; border-radius:16px; padding:20px; box-shadow:0 4px 12px rgba(0,0,0,0.1); margin:16px 0; position:relative; min-height:150px; }
    .table-header { display:flex; justify-content:space-between; margin-bottom:12px; font-weight:500; }
    .trick-cards { display:flex; justify-content:center; gap:25px; margin-top:15px; position:relative; height:100px; }
    .card-pos { position:absolute; top:0; left:0; width:100%; height:100%; display:flex; justify-content:center; align-items:center; }
    .card-pos.top { top:10px; }
    .card-pos.right { right:10px; transform:rotate(90deg); }
    .card-pos.bottom { bottom:10px; }
    .card-pos.left { left:10px; transform:rotate(-90deg); }
    .card { width:55px; height:85px; border-radius:8px; background:white; border:1px solid #e2e8f0; display:flex; align-items:center; justify-content:center; font-weight:600; font-size:0.8rem; box-shadow:1px 2px 4px rgba(0,0,0,0.1); position:relative; user-select:none; }
    .card.heart { color:#ef4444; border-color:#fecaca; }
    .card.spade { color:#1e293b; }
    .card.diamond { color:#f59e0b; }
    .card.club { color:#0d9488; }
    .card.special { box-shadow:0 0 0 2px gold; }
    .hand-area { background:white; border-radius:16px; padding:16px; box-shadow:0 4px 12px rgba(0,0,0,0.1); margin:16px 0; }
    .hand-title { display:flex; justify-content:space-between; align-items:center; margin-bottom:12px; padding-bottom:8px; border-bottom:1px solid #f1f5f9; }
    .cards-container { display:flex; flex-wrap:wrap; gap:6px; min-height:110px; justify-content:center; align-items:center; padding:4px; }
    .card.self { cursor:pointer; transform:scale(1.12); z-index:20; box-shadow:0 0 0 2px var(--primary); }
    .card.self:hover { transform:scale(1.18); box-shadow:0 0 0 3px #60a5fa; }
    .card.played { opacity:0.5; cursor:not-allowed; transform:scale(0.95); }
    .chat-area { background:white; border-radius:12px; padding:16px; box-shadow:0 2px 8px rgba(0,0,0,0.1); margin-top:16px; }
    .chat-messages { height:110px; overflow-y:auto; border-bottom:1px solid #f1f5f9; padding-bottom:8px; margin-bottom:10px; font-size:0.95rem; line-height:1.6; }
    .chat-msg { padding:4px 0; border-bottom:1px dashed #f1f5f9; }
    .chat-system { color:var(--gray); font-style:italic; }
    .chat-input { display:flex; gap:8px; }
    .chat-input input { flex:1; padding:10px 14px; border:1px solid #ddd; border-radius:8px; font-size:0.95rem; }
    .btn { background:var(--primary); color:white; border:none; border-radius:8px; padding:10px 18px; font-weight:600; cursor:pointer; transition:all 0.2s; white-space:nowrap; }
    .btn:hover { opacity:0.95; transform:translateY(-1px); }
    .btn:disabled { background:#9ca3af; cursor:not-allowed; transform:none; opacity:1; }
    .room-id { background:#dbeafe; color:var(--primary); font-weight:700; padding:4px 10px; border-radius:6px; letter-spacing:1.5px; font-size:1.1rem; }
    .status-bar { background:#fffbeb; color:#92400e; padding:10px; border-radius:8px; margin:16px 0; text-align:center; font-weight:500; border-left:3px solid #f59e0b; display:none; }
    .rules-btn { background:#f1f5f9; color:var(--gray); margin-left:10px; padding:6px 12px; }
    .modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:1000; justify-content:center; align-items:center; }
    .modal-content { background:white; border-radius:16px; width:90%; max-width:600px; max-height:80%; overflow:auto; padding:24px; box-shadow:0 10px 25px rgba(0,0,0,0.2); }
    .close-modal { float:right; font-size:1.5rem; cursor:pointer; color:var(--gray); }
    @media (max-width:768px) {
      .players-grid { grid-template-columns:repeat(2,1fr); }
      .card { width:42px; height:65px; font-size:0.65rem; }
      .trick-cards { gap:10px; }
      .room-bar { flex-direction:column; align-items:stretch; }
      .header h1 { font-size:1.5rem; }
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>ğŸ· æ‹±çŒª Â· å¥½å‹æˆ¿è”æœºç‰ˆ</h1>
    <p>4äººå¯¹æˆ˜ï½œæˆ¿é—´ç é‚€è¯·ï½œæç®€è§„åˆ™ï½œåŒ¿åæ¸¸ç©</p>
    <button class="btn rules-btn" onclick="document.getElementById('rulesModal').style.display='flex'">ğŸ“œ è§„åˆ™é€ŸæŸ¥</button>
  </div>
  
  <div class="room-bar">
    <div><strong>æˆ¿é—´:</strong> <span id="roomId" class="room-id">----</span></div>
    <div><strong>çŠ¶æ€:</strong> <span id="gameStatus">ç­‰å¾…åˆ›å»ºæˆ¿é—´...</span></div>
    <div>
      <button id="createRoomBtn" class="btn">âœ¨ åˆ›å»ºæˆ¿é—´</button>
      <button id="joinRoomBtn" class="btn" style="background:#8b5cf6; margin-left:8px;" onclick="joinRoomPrompt()">ğŸšª åŠ å…¥æˆ¿é—´</button>
    </div>
  </div>

  <div class="players-grid">
    <div class="player-card" id="player0"><div class="player-name">-</div><div class="player-score">0</div></div>
    <div class="player-card" id="player1"><div class="player-name">-</div><div class="player-score">0</div></div>
    <div class="player-card" id="player2"><div class="player-name">-</div><div class="player-score">0</div></div>
    <div class="player-card" id="player3"><div class="player-name">-</div><div class="player-score">0</div></div>
  </div>

  <div class="table-area">
    <div class="table-header">
      <div>å½“å‰è½®æ¬¡: <span id="trickCount">0</span>/13</div>
      <div>å‡ºç‰ŒèŠ±è‰²: <span id="leadSuit" style="color:var(--primary); font-weight:600">-</span></div>
      <div>æœ¬è½®åˆ†æ•°: <span id="trickPoints">0</span></div>
    </div>
    <div class="trick-cards" id="trickCards">
      <div class="card-pos top" id="cardPos0"></div>
      <div class="card-pos right" id="cardPos1"></div>
      <div class="card-pos bottom" id="cardPos2"></div>
      <div class="card-pos left" id="cardPos3"></div>
    </div>
  </div>

  <div class="hand-area">
    <div class="hand-title">
      <div>æˆ‘çš„æ‰‹ç‰Œ (<span id="handCount">0</span> å¼ )</div>
      <div id="turnHint" style="color:var(--primary); font-weight:600;"></div>
    </div>
    <div class="cards-container" id="handCards"></div>
  </div>

  <div class="chat-area">
    <div class="chat-messages" id="chatMessages"></div>
    <div class="chat-input">
      <input type="text" id="chatInput" placeholder="è¾“å…¥æ¶ˆæ¯ï¼ˆå›è½¦å‘é€ï¼‰" maxlength="50">
      <button id="sendChatBtn" class="btn" style="padding:10px 16px;">ğŸ’¬</button>
    </div>
  </div>

  <div class="status-bar" id="statusBar"></div>

  <!-- è§„åˆ™è¯´æ˜å¼¹çª— -->
  <div class="modal" id="rulesModal">
    <div class="modal-content">
      <span class="close-modal" onclick="document.getElementById('rulesModal').style.display='none'">&times;</span>
      <h2 style="margin:10px 0; color:var(--primary);">ğŸ· æ‹±çŒªè§„åˆ™é€ŸæŸ¥</h2>
      <ul style="line-height:1.8; padding-left:20px; margin:15px 0;">
        <li><strong>å‡ºç‰Œ</strong>ï¼šæ¯è½®ç”±é¢†å‡ºè€…å®šèŠ±è‰²ï¼Œå…¶ä»–äººå¿…é¡»è·Ÿå‡ºåŒèŠ±è‰²ï¼ˆæ— åˆ™å¯å«ç‰Œï¼‰</li>
        <li><strong>æ”¶ç‰Œ</strong>ï¼šåŒèŠ±è‰²ä¸­ç‚¹æ•°æœ€å¤§è€…ï¼ˆA>K>Q>J>10>...>2ï¼‰æ”¶èµ°æœ¬å¢©æ‰€æœ‰ç‰Œ</li>
        <li><strong>è®¡åˆ†ç‰Œ</strong>ï¼š
          <ul style="margin-top:8px; padding-left:20px;">
            <li>â™¥2-10ï¼šæ¯å¼ -10åˆ†ï½œâ™¥Jï¼š-20ï½œâ™¥Qï¼š-30ï½œâ™¥Kï¼š-40ï½œâ™¥Aï¼š-50</li>
            <li>â™ Qï¼š-100ï½œâ™¦Jï¼š+100ï½œâ™£10ï¼šç¿»å€å™¨ï¼ˆä½¿æŒæœ‰è€…æœ¬å±€æ€»åˆ†Ã—2ï¼‰</li>
          </ul>
        </li>
        <li><strong>ç‰¹æ®Šå¥–åŠ±</strong>ï¼ˆäº’æ–¥ï¼Œå–æœ€é«˜ï¼‰ï¼š
          <ul style="margin-top:8px; padding-left:20px;">
            <li>æ”¶é½å…¨éƒ¨16å¼ ç‰¹æ®Šç‰Œï¼š+500åˆ†</li>
            <li>ä»…æ”¶â™¦J+â™ Qï¼ˆæ— å…¶ä»–ç‰¹æ®Šç‰Œï¼‰ï¼š+200åˆ†</li>
            <li>ä»…æ”¶â™£10ï¼ˆæ— å…¶ä»–ç‰¹æ®Šç‰Œï¼‰ï¼š+50åˆ†</li>
          </ul>
        </li>
        <li><strong>èƒœè´Ÿ</strong>ï¼šä»»ä¸€ç©å®¶æ€»åˆ† â‰¤ -1500 åˆ†æ—¶æ¸¸æˆç»“æŸ</li>
      </ul>
      <p style="margin-top:15px; padding-top:10px; border-top:1px dashed #ddd; font-weight:500;">
        ğŸ’¡ æç¤ºï¼šâ™£10ä¼šä½¿ä½ æœ¬å±€æ‰€æœ‰åˆ†æ•°ç¿»å€ï¼ˆå«æ­£è´Ÿåˆ†ï¼‰ï¼ç­–ç•¥æ€§ä¿ç•™/ç”©å‡ºæ˜¯å…³é”®
      </p>
    </div>
  </div>

  <script>
    // ====================== é…ç½®åŒº ======================
    // éƒ¨ç½²åæ›¿æ¢ä¸ºæ‚¨çš„WebSocketæœåŠ¡å™¨åœ°å€ï¼ˆç¤ºä¾‹ä½¿ç”¨å…è´¹æµ‹è¯•æœåŠ¡å™¨ï¼‰
    const WS_URL = "wss://gongzhu-server.onrender.com"; // å®é™…éƒ¨ç½²æ—¶æ›¿æ¢ï¼
    // ====================================================

    let ws = null;
    let roomId = null;
    let playerId = null;
    let playerName = null;
    let isMyTurn = false;
    const suitMap = { 'H': 'â™¥', 'S': 'â™ ', 'D': 'â™¦', 'C': 'â™£' };
    const rankMap = { 'A':14, 'K':13, 'Q':12, 'J':11, '10':10, '9':9, '8':8, '7':7, '6':6, '5':5, '4':4, '3':3, '2':2 };
    
    // åˆå§‹åŒ–
    document.getElementById('createRoomBtn').onclick = createRoom;
    document.getElementById('sendChatBtn').onclick = sendChat;
    document.getElementById('chatInput').onkeypress = (e) => { if(e.key==='Enter') sendChat(); };
    
    // åˆ›å»ºæˆ¿é—´
    function createRoom() {
      if(ws && ws.readyState === WebSocket.OPEN) {
        alert('å·²åœ¨æˆ¿é—´ä¸­ï¼å¦‚éœ€æ–°æˆ¿é—´è¯·åˆ·æ–°é¡µé¢');
        return;
      }
      roomId = Math.floor(100000 + Math.random()*900000).toString();
      connectToServer();
    }
    
    // åŠ å…¥æˆ¿é—´
    function joinRoomPrompt() {
      const code = prompt('è¯·è¾“å…¥6ä½æˆ¿é—´ç ï¼š');
      if(code && /^\d{6}$/.test(code)) {
        roomId = code;
        connectToServer();
      } else if(code) {
        alert('æˆ¿é—´ç å¿…é¡»æ˜¯6ä½æ•°å­—ï¼');
      }
    }
    
    // è¿æ¥æœåŠ¡å™¨
    function connectToServer() {
      if(ws) ws.close();
      document.getElementById('roomId').textContent = roomId;
      document.getElementById('gameStatus').textContent = 'è¿æ¥ä¸­...';
      
      // ç”Ÿæˆä¸´æ—¶æ˜µç§°
      const nicknames = ['æ‹±çŒªä¾ ','ç”©ç‰Œç‹','â™£10çŒäºº','â™¥æ”¶é›†è€…','â™ Qææƒ§ç—‡','ç¿»å€å¤§å¸ˆ','å†·é™åˆ†æè€…','æ‰‹æ°”ç‹'];
      playerName = nicknames[Math.floor(Math.random()*nicknames.length)] + '#' + Math.floor(1000+Math.random()*9000);
      
      try {
        ws = new WebSocket(`${WS_URL}?room=${roomId}&name=${encodeURIComponent(playerName)}`);
        
        ws.onopen = () => {
          addChatMsg(`âœ… å·²è¿æ¥åˆ°æœåŠ¡å™¨`, 'system');
          document.getElementById('gameStatus').textContent = 'ç­‰å¾…å…¶ä»–ç©å®¶...';
        };
        
        ws.onmessage = (event) => {
          try {
            const data = JSON.parse(event.data);
            handleServerMessage(data);
          } catch(e) {
            console.error('è§£ææ¶ˆæ¯å¤±è´¥:', e);
          }
        };
        
        ws.onclose = () => {
          setTimeout(() => {
            if(!ws || ws.readyState !== WebSocket.OPEN) {
              document.getElementById('gameStatus').textContent = 'è¿æ¥æ–­å¼€ï¼Œå¯åˆ·æ–°é‡è¯•';
              addChatMsg('âš ï¸ ä¸æœåŠ¡å™¨è¿æ¥æ–­å¼€', 'system');
            }
          }, 1000);
        };
        
        ws.onerror = (err) => {
          console.error('WebSocketé”™è¯¯:', err);
          addChatMsg('âŒ è¿æ¥æœåŠ¡å™¨å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–ç¨åé‡è¯•', 'system');
        };
      } catch(e) {
        console.error('è¿æ¥å¤±è´¥:', e);
        addChatMsg(`âŒ è¿æ¥é”™è¯¯: ${e.message}`, 'system');
      }
    }
    
    // å¤„ç†æœåŠ¡å™¨æ¶ˆæ¯
    function handleServerMessage(msg) {
      switch(msg.type) {
        case 'room_joined':
          document.getElementById('gameStatus').textContent = `å·²åŠ å…¥æˆ¿é—´ï¼ˆ${msg.playerCount}/4ï¼‰`;
          updatePlayerNames(msg.players);
          if(msg.isHost) document.getElementById('createRoomBtn').disabled = true;
          addChatMsg(`${msg.name} åŠ å…¥äº†æˆ¿é—´`, 'system');
          break;
          
        case 'game_start':
          document.getElementById('gameStatus').textContent = 'æ¸¸æˆå¼€å§‹ï¼å‘ç‰Œä¸­...';
          renderHandCards(msg.hand);
          document.getElementById('trickCount').textContent = '0';
          document.getElementById('leadSuit').textContent = '-';
          document.getElementById('trickPoints').textContent = '0';
          clearTrickCards();
          addChatMsg('ğŸƒ æ¸¸æˆå¼€å§‹ï¼è¯·ç­‰å¾…å‡ºç‰Œ...', 'system');
          break;
          
        case 'your_turn':
          isMyTurn = true;
          document.getElementById('turnHint').textContent = 'ğŸ‘‰ è½®åˆ°ä½ å‡ºç‰Œï¼';
          document.getElementById('gameStatus').textContent = 'ä½ çš„å›åˆ';
          enableHandCards(msg.leadSuit || null);
          break;
          
        case 'card_played':
          // æ›´æ–°å‡ºç‰ŒåŒº
          const pos = msg.position;
          const cardEl = createCardElement(msg.card);
          document.getElementById(`cardPos${pos}`).innerHTML = '';
          document.getElementById(`cardPos${pos}`).appendChild(cardEl);
          
          // æ›´æ–°çŠ¶æ€
          if(msg.leadSuit) {
            document.getElementById('leadSuit').textContent = suitMap[msg.leadSuit] || msg.leadSuit;
          }
          if(msg.trickPoints !== undefined) {
            document.getElementById('trickPoints').textContent = msg.trickPoints;
          }
          
          // ç¦ç”¨æ‰‹ç‰Œï¼ˆéè‡ªå·±å›åˆï¼‰
          if(msg.playerId !== playerId) disableHandCards();
          addChatMsg(`${msg.name} å‡ºäº† ${formatCard(msg.card)}`, 'system');
          break;
          
        case 'trick_end':
          document.getElementById('trickCount').textContent = msg.trickNumber;
          // é‡ç½®å‡ºç‰ŒåŒºï¼ˆçŸ­æš‚æ˜¾ç¤ºåæ¸…ç©ºï¼‰
          setTimeout(clearTrickCards, 1500);
          addChatMsg(`âœ… ${msg.winnerName} æ”¶èµ°æœ¬å¢©ç‰Œï¼ˆå«${msg.points}åˆ†ï¼‰`, 'system');
          break;
          
        case 'round_end':
          updateScores(msg.scores);
          document.getElementById('gameStatus').textContent = 'æœ¬å±€ç»“æŸï¼Œå‡†å¤‡ä¸‹ä¸€å±€...';
          addChatMsg(`ğŸ‰ æœ¬å±€ç»“æŸï¼åˆ†æ•°å·²æ›´æ–°`, 'system');
          // æ£€æŸ¥æ¸¸æˆç»“æŸ
          if(msg.gameOver) {
            setTimeout(() => {
              alert(`ğŸ† æ¸¸æˆç»“æŸï¼\n${msg.winner} è·èƒœï¼\n\næœ€ç»ˆåˆ†æ•°ï¼š\n${msg.scores.map(s=>`${s.name}: ${s.total}`).join('\n')}`);
              document.getElementById('gameStatus').textContent = 'æ¸¸æˆå·²ç»“æŸ';
            }, 1000);
          }
          break;
          
        case 'chat':
          addChatMsg(`${msg.name}: ${msg.text}`, 'user');
          break;
          
        case 'error':
          addChatMsg(`âŒ ${msg.message}`, 'system');
          break;
      }
    }
    
    // æ¸²æŸ“æ‰‹ç‰Œ
    function renderHandCards(cards) {
      const container = document.getElementById('handCards');
      container.innerHTML = '';
      cards.forEach(card => {
        const el = createCardElement(card, true);
        el.onclick = () => playCard(card);
        container.appendChild(el);
      });
      document.getElementById('handCount').textContent = cards.length;
    }
    
    // åˆ›å»ºå¡ç‰Œå…ƒç´ 
    function createCardElement(cardStr, isSelf=false) {
      const el = document.createElement('div');
      el.className = `card ${getSuitClass(cardStr)}`;
      if(isSelf) el.classList.add('self');
      if(['SQ','DJ','C10'].includes(cardStr) || cardStr.startsWith('H')) el.classList.add('special');
      
      const suit = suitMap[cardStr[0]] || cardStr[0];
      const rank = cardStr.slice(1);
      el.innerHTML = `<div>${suit}</div><div style="font-size:0.7em;margin-top:-2px">${rank}</div>`;
      return el;
    }
    
    // è·å–èŠ±è‰²CSSç±»
    function getSuitClass(card) {
      const s = card[0];
      return s === 'H' ? 'heart' : s === 'S' ? 'spade' : s === 'D' ? 'diamond' : 'club';
    }
    
    // æ ¼å¼åŒ–å¡ç‰Œæ˜¾ç¤º
    function formatCard(card) {
      return `${suitMap[card[0]] || card[0]}${card.slice(1)}`;
    }
    
    // å‡ºç‰Œ
    function playCard(card) {
      if(!isMyTurn || !ws || ws.readyState !== WebSocket.OPEN) return;
      
      ws.send(JSON.stringify({ type: 'play_card', card }));
      isMyTurn = false;
      document.getElementById('turnHint').textContent = '';
      disableHandCards();
    }
    
    // å¯ç”¨æ‰‹ç‰Œï¼ˆä»…å¯å‡ºçš„ç‰Œï¼‰
    function enableHandCards(leadSuit) {
      const cards = document.querySelectorAll('.card.self');
      cards.forEach(card => {
        const cardStr = card.dataset.card; // å®é™…éœ€ä»æ•°æ®ç»‘å®šï¼Œæ­¤å¤„ç®€åŒ–
        // ç®€åŒ–ï¼šæ‰€æœ‰ç‰Œå¯ç‚¹ï¼ˆåç«¯æ ¡éªŒï¼‰ï¼Œä»…è§†è§‰æç¤º
        card.style.opacity = '1';
        card.style.cursor = 'pointer';
      });
    }
    
    // ç¦ç”¨æ‰‹ç‰Œ
    function disableHandCards() {
      const cards = document.querySelectorAll('.card.self');
      cards.forEach(card => {
        card.style.opacity = '0.6';
        card.style.cursor = 'not-allowed';
      });
    }
    
    // æ¸…ç©ºå‡ºç‰ŒåŒº
    function clearTrickCards() {
      document.querySelectorAll('.card-pos').forEach(el => el.innerHTML = '');
      document.getElementById('leadSuit').textContent = '-';
      document.getElementById('trickPoints').textContent = '0';
    }
    
    // æ›´æ–°ç©å®¶ä¿¡æ¯
    function updatePlayerNames(players) {
      players.forEach((p, i) => {
        if(document.getElementById(`player${i}`)) {
          document.querySelector(`#player${i} .player-name`).textContent = p.name || `ç©å®¶${i+1}`;
          document.querySelector(`#player${i} .player-score`).textContent = p.score || '0';
          document.querySelector(`#player${i} .player-score`).className = 'player-score ' + 
            (p.score < 0 ? 'negative' : p.score > 0 ? 'positive' : '');
          if(p.isCurrentTurn) {
            document.getElementById(`player${i}`).classList.add('current-turn');
          } else {
            document.getElementById(`player${i}`).classList.remove('current-turn');
          }
        }
      });
    }
    
    // æ›´æ–°åˆ†æ•°
    function updateScores(scores) {
      scores.forEach((s, i) => {
        const el = document.querySelector(`#player${i} .player-score`);
        if(el) {
          el.textContent = s.total;
          el.className = 'player-score ' + (s.total < 0 ? 'negative' : s.total > 0 ? 'positive' : '');
        }
      });
    }
    
    // èŠå¤©
    function sendChat() {
      const input = document.getElementById('chatInput');
      const text = input.value.trim();
      if(text && ws && ws.readyState === WebSocket.OPEN) {
        ws.send(JSON.stringify({ type: 'chat', text }));
        input.value = '';
      }
    }
    
    function addChatMsg(text, type) {
      const chatBox = document.getElementById('chatMessages');
      const msg = document.createElement('div');
      msg.className = `chat-msg ${type === 'system' ? 'chat-system' : ''}`;
      msg.textContent = `[${new Date().toLocaleTimeString('zh-CN', {hour12:false, hour:'2-digit', minute:'2-digit'})}] ${text}`;
      chatBox.appendChild(msg);
      chatBox.scrollTop = chatBox.scrollHeight;
      
      // ç³»ç»Ÿæ¶ˆæ¯çŠ¶æ€æ æç¤º
      if(type === 'system' && !text.startsWith('[')) {
        const bar = document.getElementById('statusBar');
        bar.textContent = text;
        bar.style.display = 'block';
        setTimeout(() => { bar.style.display = 'none'; }, 5000);
      }
    }
    
    // é¡µé¢åŠ è½½æç¤º
    window.onload = () => {
      if(location.hostname === 'localhost' || location.hostname === '127.0.0.1') {
        document.getElementById('statusBar').innerHTML = 'ğŸ’¡ <strong>å¼€å‘æç¤º</strong>ï¼šæœ¬åœ°æµ‹è¯•æ¨¡å¼ï¼Œè¿æ¥åœ°å€éœ€æ›¿æ¢ä¸ºæ‚¨çš„æœåŠ¡å™¨åœ°å€ï¼ˆè§ä»£ç ç¬¬18è¡Œï¼‰';
        document.getElementById('statusBar').style.display = 'block';
        document.getElementById('statusBar').style.background = '#dbeafe';
        document.getElementById('statusBar').style.color = '#1e40af';
      }
    };
    
    // ç¦»å¼€é¡µé¢æç¤º
    window.onbeforeunload = () => {
      if(ws && ws.readyState === WebSocket.OPEN) {
        return 'ç¦»å¼€é¡µé¢å°†æ–­å¼€æ¸¸æˆè¿æ¥ï¼Œç¡®è®¤ç¦»å¼€ï¼Ÿ';
      }
    };
  </script>
</body>
</html>